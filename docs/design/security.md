# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆæ›¸

## æ¦‚è¦

æŠ€è¡“è¨˜äº‹è¦ç´„ã‚µãƒ¼ãƒ“ã‚¹ã€ŒTechSnapã€ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã€è„…å¨åˆ†æã€å¯¾ç­–ã€ãŠã‚ˆã³é‹ç”¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã™ã€‚

## 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ–¹é‡

### 1.1 åŸºæœ¬æ–¹é‡

- **æœ€å°æ¨©é™ã®åŸå‰‡**: å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿ä»˜ä¸
- **å¤šå±¤é˜²å¾¡**: è¤‡æ•°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’çµ„ã¿åˆã‚ã›
- **ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆ**: å†…éƒ¨ãƒ»å¤–éƒ¨ã‚’å•ã‚ãšå…¨ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ¤œè¨¼
- **ãƒ‡ãƒ¼ã‚¿ä¿è­·**: å€‹äººæƒ…å ±ãƒ»æ©Ÿå¯†æƒ…å ±ã®é©åˆ‡ãªä¿è­·
- **é€æ˜æ€§**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®å¯è¦–åŒ–ã¨ç›£æŸ»

### 1.2 ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹

å€‹äººåˆ©ç”¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãŸã‚ã€ä»¥ä¸‹ã®åŸºæº–ã‚’å‚è€ƒã«è¨­è¨ˆï¼š

- **OWASP Top 10**: Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- **Google Cloud Security Best Practices**
- **Firebase Security Rules Best Practices**
- **å€‹äººæƒ…å ±ä¿è­·æ³•**ï¼ˆæ—¥æœ¬ï¼‰

## 2. è„…å¨åˆ†æ

### 2.1 è„…å¨ãƒ¢ãƒ‡ãƒ«

#### 2.1.1 å¤–éƒ¨è„…å¨

| è„…å¨                 | å½±éŸ¿åº¦ | ç™ºç”Ÿç¢ºç‡ | ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ« |
| -------------------- | ------ | -------- | ------------ |
| DDoS æ”»æ’ƒ            | é«˜     | ä¸­       | é«˜           |
| SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ | é«˜     | ä½       | ä¸­           |
| XSS æ”»æ’ƒ             | ä¸­     | ä¸­       | ä¸­           |
| CSRF æ”»æ’ƒ            | ä¸­     | ä½       | ä½           |
| èªè¨¼çªç ´             | é«˜     | ä½       | ä¸­           |
| ãƒ‡ãƒ¼ã‚¿æ¼æ´©           | é«˜     | ä½       | ä¸­           |

#### 2.1.2 å†…éƒ¨è„…å¨

| è„…å¨     | å½±éŸ¿åº¦ | ç™ºç”Ÿç¢ºç‡ | ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ« |
| -------- | ------ | -------- | ------------ |
| è¨­å®šãƒŸã‚¹ | ä¸­     | ä¸­       | ä¸­           |
| æ¨©é™æ˜‡æ ¼ | é«˜     | ä½       | ä¸­           |
| å†…éƒ¨ä¸æ­£ | ä½     | ä½       | ä½           |
| äººçš„ãƒŸã‚¹ | ä¸­     | ä¸­       | ä¸­           |

#### 2.1.3 æŠ€è¡“çš„è„…å¨

| è„…å¨             | å½±éŸ¿åº¦ | ç™ºç”Ÿç¢ºç‡ | ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ« |
| ---------------- | ------ | -------- | ------------ |
| è„†å¼±æ€§æ‚ªç”¨       | é«˜     | ä¸­       | é«˜           |
| ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ | ä¸­     | é«˜       | é«˜           |
| è¨­å®šä¸å‚™         | ä¸­     | ä¸­       | ä¸­           |
| ãƒ­ã‚°æ”¹ã–ã‚“       | ä½     | ä½       | ä½           |

## 3. èªè¨¼ãƒ»èªå¯è¨­è¨ˆ

### 3.1 Firebase Authentication

#### 3.1.1 èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®š

```javascript
// firebase-auth-config.js
import { initializeApp } from "firebase/app";
import { getAuth, GoogleAuthProvider } from "firebase/auth";

const firebaseConfig = {
  // è¨­å®šå€¤ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
};

const app = initializeApp(firebaseConfig);
export const auth = getAuth(app);

// Googleãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®š
export const googleProvider = new GoogleAuthProvider();
googleProvider.setCustomParameters({
  prompt: "select_account",
});
```

#### 3.1.2 èªè¨¼ãƒ•ãƒ­ãƒ¼

```typescript
// auth-service.ts
interface AuthService {
  signInWithGoogle(): Promise<UserCredential>;
  signOut(): Promise<void>;
  getCurrentUser(): User | null;
  onAuthStateChanged(callback: (user: User | null) => void): Unsubscribe;
}

class FirebaseAuthService implements AuthService {
  async signInWithGoogle(): Promise<UserCredential> {
    try {
      const result = await signInWithPopup(auth, googleProvider);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’Firestoreã«ä¿å­˜
      await this.createUserProfile(result.user);

      return result;
    } catch (error) {
      console.error("èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
      throw new AuthError("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  }

  private async createUserProfile(user: User): Promise<void> {
    const userRef = doc(db, "users", user.uid);
    const userDoc = await getDoc(userRef);

    if (!userDoc.exists()) {
      await setDoc(userRef, {
        uid: user.uid,
        email: user.email,
        displayName: user.displayName,
        photoURL: user.photoURL,
        createdAt: serverTimestamp(),
        lastLoginAt: serverTimestamp(),
        preferences: {
          theme: "light",
          language: "ja",
          summaryStyle: "technical",
        },
      });
    } else {
      // æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»æ›´æ–°
      await updateDoc(userRef, {
        lastLoginAt: serverTimestamp(),
      });
    }
  }
}
```

### 3.2 Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«

#### 3.2.1 åŸºæœ¬ãƒ«ãƒ¼ãƒ«

```javascript
// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    match /users/{userId} {
      // è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿èª­ã¿æ›¸ãå¯èƒ½
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // ä½œæˆæ™‚ã®æ¤œè¨¼
      allow create: if request.auth != null
        && request.auth.uid == userId
        && validateUserData(request.resource.data);
    }

    // è¦ç´„ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    match /summaries/{summaryId} {
      // è‡ªåˆ†ã®è¦ç´„ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
      allow read, write: if request.auth != null
        && request.auth.uid == resource.data.userId;

      // ä½œæˆæ™‚ã®æ¤œè¨¼
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.userId
        && validateSummaryData(request.resource.data);
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
    match /cache/{cacheId} {
      allow read: if request.auth != null;
      allow write: if false; // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿
    }

    // ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    match /admin/{document=**} {
      allow read, write: if request.auth != null
        && request.auth.token.admin == true;
    }
  }

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
  function validateUserData(data) {
    return data.keys().hasAll(['uid', 'email', 'createdAt'])
      && data.uid is string
      && data.email is string
      && data.email.matches('.*@.*\\..*');
  }

  function validateSummaryData(data) {
    return data.keys().hasAll(['userId', 'title', 'lUrl', 'summary', 'createdAt'])
      && data.userId is string
      && data.title is string
      && data.originalUrl is string
      && data.summary is string
      && data.originalUrl.matches('https?://.*');
  }
}
```

#### 3.2.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ

```javascript
// firestore-rules.test.js
import {
  initializeTestEnvironment,
  assertFails,
  assertSucceeds,
} from "@firebase/rules-unit-testing";

describe("Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«", () => {
  let testEnv;

  beforeAll(async () => {
    testEnv = await initializeTestEnvironment({
      projectId: "test-project",
      firestore: {
        rules: fs.readFileSync("firestore.rules", "utf8"),
      },
    });
  });

  test("èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½", async () => {
    const alice = testEnv.authenticatedContext("alice");
    const aliceDoc = alice.firestore().doc("users/alice");

    await assertSucceeds(
      aliceDoc.set({
        uid: "alice",
        email: "alice@example.com",
        createdAt: new Date(),
      })
    );

    await assertSucceeds(aliceDoc.get());
  });

  test("ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯", async () => {
    const alice = testEnv.authenticatedContext("alice");
    const bobDoc = alice.firestore().doc("users/bob");

    await assertFails(bobDoc.get());
    await assertFails(bobDoc.set({ uid: "bob" }));
  });
});
```

## 4. ãƒ‡ãƒ¼ã‚¿ä¿è­·

### 4.1 ãƒ‡ãƒ¼ã‚¿åˆ†é¡

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥       | æ©Ÿå¯†ãƒ¬ãƒ™ãƒ« | ä¿è­·è¦ä»¶     | ä¿å­˜å ´æ‰€      |
| ---------------- | ---------- | ------------ | ------------- |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æƒ…å ± | é«˜         | æš—å·åŒ–å¿…é ˆ   | Firebase Auth |
| å€‹äººè¨­å®š         | ä¸­         | ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ | Firestore     |
| è¦ç´„ãƒ‡ãƒ¼ã‚¿       | ä¸­         | ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ | Firestore     |
| è¨˜äº‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥   | ä½         | ä¸€èˆ¬ä¿è­·     | Firestore     |
| ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿       | ä¸­         | ä¿æŒæœŸé–“åˆ¶é™ | Cloud Logging |

### 4.2 æš—å·åŒ–

#### 4.2.1 ä¿å­˜æ™‚æš—å·åŒ–

```hcl
# terraform/google_firestore_main.tf
resource "google_firestore_database" "main" {
  project     = var.project_id
  name        = "(default)"
  location_id = var.region
  type        = "FIRESTORE_NATIVE"

  # ä¿å­˜æ™‚æš—å·åŒ–ï¼ˆGoogleç®¡ç†ã‚­ãƒ¼ï¼‰
  encryption_config {
    kms_key_name = google_kms_crypto_key.firestore_key.id
  }
}

# KMSã‚­ãƒ¼ä½œæˆ
resource "google_kms_key_ring" "firestore_keyring" {
  name     = "firestore-keyring"
  location = var.region
}

resource "google_kms_crypto_key" "firestore_key" {
  name     = "firestore-key"
  key_ring = google_kms_key_ring.firestore_keyring.id

  lifecycle {
    prevent_destroy = true
  }
}
```

#### 4.2.2 è»¢é€æ™‚æš—å·åŒ–

```typescript
// api-client.ts
class SecureApiClient {
  private readonly baseURL: string;
  private readonly timeout: number = 30000;

  constructor(baseURL: string) {
    this.baseURL = baseURL;
  }

  async request<T>(endpoint: string, options: RequestOptions = {}): Promise<T> {
    const url = new URL(endpoint, this.baseURL);

    // HTTPSå¼·åˆ¶
    if (url.protocol !== "https:") {
      throw new Error("HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™");
    }

    const config: RequestInit = {
      ...options,
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
        ...options.headers,
      },
      // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
      credentials: "same-origin",
    };

    const response = await fetch(url.toString(), config);

    if (!response.ok) {
      throw new ApiError(`HTTP ${response.status}: ${response.statusText}`);
    }

    return response.js();
  }
}
```

### 4.3 ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒ»å‰Šé™¤

#### 4.3.1 ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼

```typescript
// data-retention.ts
interface DataRetentionPolicy {
  userProfiles: "ç„¡æœŸé™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã¾ã§ï¼‰";
  summaries: "ç„¡æœŸé™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã¾ã§ï¼‰";
  cache: "7æ—¥é–“";
  logs: "30æ—¥é–“";
  backups: "90æ—¥é–“";
}

class DataRetentionService {
  async cleanupExpiredData(): Promise<void> {
    // æœŸé™åˆ‡ã‚Œã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
    await this.cleanupExpiredCache();

    // å¤ã„ãƒ­ã‚°å‰Šé™¤
    await this.cleanupOldLogs();

    // å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤
    await this.cleanupOldBackups();
  }

  private async cleanupExpiredCache(): Promise<void> {
    const expiredDate = new Date();
    expiredDate.setDate(expiredDate.getDate() - 7);

    const query = collection(db, "cache").where("expiresAt", "<", expiredDate);

    const snapshot = await getDocs(query);
    const batch = writeBatch(db);

    snapshot.docs.forEach((doc) => {
      batch.delete(doc.ref);
    });

    await batch.commit();
  }
}
```

#### 4.3.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆGDPR å¯¾å¿œï¼‰

```typescript
// user-deletion.ts
class UserDeletionService {
  async deleteUserData(userId: string): Promise<void> {
    const batch = writeBatch(db);

    try {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å‰Šé™¤
      const userRef = doc(db, "users", userId);
      batch.delete(userRef);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦ç´„ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
      const summariesQuery = collection(db, "summaries").where(
        "userId",
        "==",
        userId
      );
      const summariesSnapshot = await getDocs(summariesQuery);

      summariesSnapshot.docs.forEach((doc) => {
        batch.delete(doc.ref);
      });

      await batch.commit();

      // Firebase Authã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
      await admin.auth().deleteUser(userId);
      ole.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†: ${userId}`);
    } catch (error) {
      console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
      throw error;
    }
  }
}
```

## 5. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 5.1 Cloud Armor è¨­å®š

```hcl
# terraform/google_security_policy.tf
resource "google_compute_security_policy" "techsnap_policy" {
  name        = "techsnap-security-policy"
  description = "TechSnapã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼"

  # DDoSä¿è­·
  rule {
    action   = "deny(403)"
    priority = "1000"
    match {
      expr {
        expression = "origin.region_code == 'CN' || origin.region_code == 'RU'"
      }
    }
    description = "ç‰¹å®šåœ°åŸŸã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™"
  }

  # ãƒ¬ãƒ¼ãƒˆåˆ¶é™
  rule {
    action   = "rate_based_ban"
    priority = "2000"
    match {
      expr {
        expression = "true"
      }
    }
    rate_limit_options {
      conform_action = "allow"
      exceed_action  = "deny(429)"
      enforce_on_key = "IP"
      rate_limit_threshold {
        count        = 100
        interval_sec = 60
      }
      ban_duration_sec = 300
    }
    description = "ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ100req/minï¼‰"
  }

  # SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
  rule {
    action   = "deny(403)"
    priority = "3000"
    match {
      expr {
        expression = "evaluatePreconfiguredExpr('sqli-stable')"
      }
    }
    description = "SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒãƒ–ãƒ­ãƒƒã‚¯"
  }

  # XSSå¯¾ç­–
  rule {
    action   = "deny(403)"
    priority = "4000"
    match {
      expr {
        expression = "evaluatePreconfiguredExpr('xss-stable')"
      }
    }
    description = "XSSæ”»æ’ƒãƒ–ãƒ­ãƒƒã‚¯"
  }

  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨±å¯
  rule {
    action   = "allow"
    priority = "2147483647"
    match {
      expr {
        expression = "true"
      }
    }
    description = "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨±å¯"
  }
}
```

### 5.2 VPC ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

```hcl
# terraform/google_vpc_security.tf
resource "google_compute_network" "vpc_network" {
  name                    = "techsnap-vpc"
  auto_create_subnetworks = false
}

resource "google_compute_subnetwork" "private_subnet" {
  name          = "private-subnet"
  ip_cidr_range = "10.0.1.0/24"
  region        = var.region
  network       = google_compute_network.vpc_network.id

  # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆGoogleã‚¢ã‚¯ã‚»ã‚¹æœ‰åŠ¹åŒ–
  private_ip_google_access = true
}

# ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ãƒ«ãƒ¼ãƒ«
resource "google_compute_firewall" "allow_ht {
  name    = "allow-https"
  network = google_compute_network.vpc_network.name

  allow {
    protocol = "tcp"
    ports    = ["443"]
  }

  source_ranges = ["0.0.0.0/0"]
  target_tags   = ["https-server"]
}

resource "google_compute_firewall" "deny_all" {
  name    = "deny-all"
  network = google_compute_network.vpc_network.name

  deny {
    protocol = "all"
  }

  source_ranges = ["0.0.0.0/0"]
  priority      = 65534
}
```

## 6. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 6.1 å…¥åŠ›æ¤œè¨¼

```typescript
// input-validation.ts
import { z } from 'zod';

// URLæ¤œè¨¼ã‚¹ã‚­ãƒ¼ãƒ
const urlSchema = z.string()
  .url('æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
  .refine(url => {
    const parsed = new URL(url);
    return ['http:', 'https:'].includes(parsed.protocol);
  }, 'HTTPã¾ãŸã¯HTTPSã®URLã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã¾ã™')
  .refine(url => {
    const parsed = new URL(url);
    // å†…éƒ¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
    const hostname = parsed.hostname;
    return !isPrivateIP(hostname);
  }, 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™');

// è¦ç´„ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚¹ã‚­ãƒ¼ãƒ
const summarySchema = z.object({
  title: z.string()
    .min(1, 'ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™')
    .max(200, 'ã‚¿ã‚¤ãƒˆãƒ«ã¯200æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„')
    .refine(title => !containsXSS(title), 'XSSæ”»æ’ƒã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™'),

  originalUrl: urlSchema,

  summary: z.string()10, 'è¦ç´„ã¯10æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„')
    .max(5000, 'è¦ç´„ã¯5000æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„')
    .refine(summary => !containsXSS(summary), 'XSSæ”»æ’ƒã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™'),

  tags: z.array(z.string())
    .max(10, 'ã‚¿ã‚°ã¯10å€‹ã¾ã§è¨­å®šã§ãã¾ã™')
    .refine(tags => tags.every(tag => tag.length <= 50), 'ã‚¿ã‚°ã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„')
});

function isPrivateIP(hostname: string): boolean {
  const privateRanges = [
    /^10\./,
    /^172\.(1[6-9]|2[0-9]|3[0-1])\./,
    /^192\.168\./,
    /^127\./,
    /^localhost$/i
  ];

  return privateRanges.some(range => range.test(hostname));
}

function containsXSS(input: string): boolean {
  const xssPatterns = [
    /<script/i,
    /javascript:/i,
    /on\w+\s*=/i,
    /<iframe/i,
    /<object/i,
    /<embed/i
  ];

  return xssPatterns.some(pattern => pattern.test(input));
}
```

### 6.2 CSRF å¯¾ç­–

```typescript
// csrf-protection.ts
import { NextApiRequest, NextApiResponse } from "next";
import { getToken } from "next-auth/jwt";

export function withCSRFProtection(handler: Function) {
  return async (req: NextApiRequest, res: NextApiResponse) => {
    // GETä»¥å¤–ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§CSRFãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
    if (req.method !== "GET") {
      const token = await getToken({ req });
      const csrfToken = req.headers["x-csrf-token"];
      if (!token || !csrfToken || token.csrfToken !== csrfToken) {
        return res.status(403).json({ error: "CSRF token mismatch" });
      }
    }

    return handler(req, res);
  };
}

// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
export function setSecurityHeaders(res: NextApiResponse) {
  res.setHeader("X-Content-Type-Options", "nosniff");
  res.setHeader("X-Frame-Options", "DENY");
  res.setHeader("X-XSS-Protection", "1; mode=block");
  res.setHeader("Referrer-Poliict-origin-when-cross-origin");
  res.setHeader(
    "Content-Security-Policy",
    "default-src 'self'; " +
      "script-src 'self' 'unsafe-inline' https://apis.google.com; " +
      "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; " +
      "font-src 'self' https://fonts.gstatic.com; " +
      "img-src 'self' data: https:; " +
      "connect-src 'self' https://api.openai.com https://*.googleapis.com"
  );
}
```

## 7. ç›£æŸ»ãƒ»ãƒ­ã‚°

### 7.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°

```typescript
// security-logger.ts
interface SecurityEvent {
  eventType: 'AUTH_SUCCESS' | 'AUTH_FAILURE' | 'PERMISSION_DENIED' | 'SUSPICIOUS_ACTIVITY';
  userId?: string;
  ipAddress: string;
  userAgent: string;
  timestamp: Date;
  details: Record<string, any>;
}

class SecurityLogger {
  async logSecurityEvent(event: SecurityEvent): Promise<void> {
    const logEntry = {
      ...event,
      severity: this.getSeverity(event.eventType),
      source: 'techsnap'
    };

    // Cloud Loggingã«é€ä¿¡
    console.log(JSON.stringify(logEntry));

    // é‡è¦ãªã‚¤ãƒ™ãƒ³ãƒˆã¯Firestoreã«ã‚‚ä¿å­˜
    if (this.isCriticalEvent(event.eventType)) {
      await this.saveToFirestore(logEntry);
    }
  }

  private getSeverity(eventType: string): string {
    const severityMap = {
      'AUTH_SUCCESS': 'INFO',
      'AUTH_FAILURE': 'WARNING',
      'PERMISSION_DENIED': 'ERROR',
      'SUSPICIOUS_ACTIVITY': 'CRITICAL'
    };

    return severityMap[eventType] || 'INFO';
  }

  private isCriticalEvent(eventType: string): boolean {
    return ['PERMISSION_DENIED', 'SUSPICIOUS.includes(eventType);
  }
}
```

### 7.2 ç›£æŸ»ãƒ­ã‚°åˆ†æ

```bash
#!/bin/bash
# security-audit.sh

echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ ==="
echo "å®Ÿè¡Œæ—¥æ™‚: $(date)"

# èªè¨¼å¤±æ•—ã®åˆ†æ
echo "## èªè¨¼å¤±æ•—åˆ†æ"
gcloud logging read '
  jsonPayload.eventType="AUTH_FAILURE"
  AND timestamp>="2024-01-01T00:00:00Z"
' --format="value(jsonPayload.ipAddress)" | sort | uniq -c | sort -nr | head -10

# æ¨©é™æ‹’å¦ã®åˆ†æ
echo "## æ¨©é™æ‹’å¦åˆ†æ"
gcloud logging read '
  jsonPayload.eventType="PERMISSION_DENIED"
  AND timestamp>="2024-01-01T00:00:00Z"
' --format="value(jsonPayload.userId,jsonPayload.details)" | head -20

# ä¸å¯©ãªã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
echo "## ä¸å¯©ãªã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£"
gcloud logging read '
  jsonPayload.eventType="SUSPICIOUS_ACTIVITY"
  AND timestamp>="2024-01-01T00:00:00Z"
' --format="table(timestamp,jsonPayload.ipAddress,jsonPayload.details)"

echo "=== ç›£æŸ»å®Œäº† ==="
```

## 8. ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ

### 8.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆåˆ†é¡

| ãƒ¬ãƒ™ãƒ«   | å®šç¾©                       | å¯¾å¿œæ™‚é–“    | å¯¾å¿œãƒãƒ¼ãƒ           |
| -------- | -------------------------- | ----------- | ------------------- |
| Critical | ãƒ‡ãƒ¼ã‚¿æ¼æ´©ã€ã‚·ã‚¹ãƒ†ãƒ ä¾µå®³   | å³åº§        | é–‹ç™ºè€… + å¤–éƒ¨å°‚é–€å®¶ |
| High     | èªè¨¼çªç ´ã€æ¨©é™æ˜‡æ ¼         | 1 æ™‚é–“ä»¥å†…  | é–‹ç™ºè€…              |
| Medium   | è„†å¼±æ€§ç™ºè¦‹ã€ä¸å¯©ãªã‚¢ã‚¯ã‚»ã‚¹ | 4 æ™‚é–“ä»¥å†…  | é–‹ç™ºè€…              |
| Low      | è¨­å®šä¸å‚™ã€è»½å¾®ãªè„†å¼±æ€§     | 24 æ™‚é–“ä»¥å†… | é–‹ç™ºè€…              |

### 8.2 ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œæ‰‹é †

```bash
#!/bin/bash
# incident-response.sh

INCIDENT_TYPE=$1
SEVERITY=$2

echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œé–‹å§‹ ==="
echo "ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—: $INCIDENT_TYPE"
echo "é‡è¦åº¦: $SEVERITY"
echo "é–‹å§‹æ™‚åˆ»: $(date)"

case $SEVERITY in
  "CRITICAL")
    echo "ç·Šæ€¥å¯¾å¿œãƒ¢ãƒ¼ãƒ‰"
    # ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
    gcloud run services update techsnap --traffic=0 --platform=managed

    # ç·Šæ€¥é€šçŸ¥
    curl -X POST -H 'Content-type: application/json' \
'{"text":"ğŸš¨ CRITICAL: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç™ºç”Ÿ"}' \
      $SLACK_WEBHOOK_URL
    ;;

  "HIGH")
    echo "é«˜å„ªå…ˆåº¦å¯¾å¿œ"
    # è©²å½“æ©Ÿèƒ½ã®ç„¡åŠ¹åŒ–
    # è©³ç´°èª¿æŸ»é–‹å§‹
    ;;

  "MEDIUM"|"LOW")
    echo "é€šå¸¸å¯¾å¿œ"
    # ãƒ­ã‚°åé›†ãƒ»åˆ†æ
    ;;
esac

# è¨¼æ‹ ä¿å…¨
mkdir -p /tmp/incident-$(date +%Y%m%d-%H%M%S)
gcloud logging read "severity>=WARNING" --freshness=24h > /tmp/incident-$(date +%Y%m%d-%H%M%S)/logs.json

echo "=== åˆæœŸå¯¾å¿œå®Œäº† ==="
```

## 9. å®šæœŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»

### 9.1 è‡ªå‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³

```yaml
# .github/security-scan.yml
name: Security Scan
on:
  schedule:
    - cron: '0 2 * * 1'  # æ¯é€±æœˆæ›œæ—¥ 2:00
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate
          npm audit --json > security-audit.json
 - name: Run Snyk scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v2
        with:
          languages: javascript,typescript

      - name: Upload secreport
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-audit.json
```

### 9.2 æ‰‹å‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯

```bash
#!/bin/bash
# manual-security-check.sh

echo "=== æ‰‹å‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ ==="

# 1. IAMæ¨©é™ç›£æŸ»
echo "## IAMæ¨©é™ç›£æŸ»"
gcloud projects get-iam-policy $PROJECT_ID --format=json > iam-audit.json
python3 analyze-iam.py iam-audit.json

# 2. Firebaseã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«æ¤œè¨¼
echo "## Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«æ¤œè¨¼"
firebase emulators:exec --only firestore "npm run test:security-rules"

# 3. ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
echo "## ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯"
npm audit --audit-level=moderate

# 4. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
echo "## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼"
terraform plan -detailed-exitcode

# 5. SSL/TLSè¨­å®šç¢ºèª
echo "## SSL/TLSè¨­å®šç¢ºèª"
nmap --script ssl-enum-ciphers -p 443 your-domain.com

echo "=== ãƒã‚§ãƒƒã‚¯å®Œäº† ==="
```

## 10. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ•™è‚²ãƒ»å•“ç™º

### 10.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

å€‹äººé–‹ç™ºè€…å‘ã‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼š

- [ ] å®šæœŸçš„ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆ3 ãƒ¶æœˆæ¯ï¼‰
- [ ] äºŒè¦ç´ èªè¨¼ã®æœ‰åŠ¹åŒ–
- [ ] ä¾å­˜é–¢ä¿‚ã®å®šæœŸæ›´æ–°
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã®è¿…é€Ÿé©ç”¨
- [ ] ãƒ­ã‚°ã®å®šæœŸç¢ºèª
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å®šæœŸãƒ†ã‚¹ãƒˆ
- [ ] æ¨©é™è¨­å®šã®å®šæœŸè¦‹ç›´ã—
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®æ–‡æ›¸åŒ–

### 10.2 ç·Šæ€¥é€£çµ¡å…ˆ

- **Google Cloud Support**: <https://cloud.google.com/support>
- **Firebase Support**: <https://firebase.google.com/support>
- **JPCERT/CC**: <https://www.jpcert.or.jp/>
- **IPA ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚»ãƒ³ã‚¿ãƒ¼**: <https://www.ipa.go.jp/security/>

ã“ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆæ›¸ã¯ã€è„…å¨ã®å¤‰åŒ–ã‚„æ–°ã—ã„è„†å¼±æ€§ã®ç™ºè¦‹ã«å¿œã˜ã¦å®šæœŸçš„ã«æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

## 11. å…¬é–‹ãƒªãƒã‚¸ãƒˆãƒªã§ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 11.1 æ©Ÿå¯†æƒ…å ±ç®¡ç†

#### 11.1.1 GitHub Secrets ã®æ´»ç”¨

```bash
# æ©Ÿå¯†æƒ…å ±ã¯å…¨ã¦GitHub Secretsã§ç®¡ç†
# ãƒªãƒã‚¸ãƒˆãƒªè¨­å®š > Secrets and variables > Actions

# ç’°å¢ƒåˆ¥ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†
STAGING_*    # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒç”¨
PRODUCTION_* # æœ¬ç•ªç’°å¢ƒç”¨
```

#### 11.1.2 .env.example ã®æ´»ç”¨

```bash
# .env.exampleï¼ˆå…¬é–‹OKï¼‰
NEXT_PUBLIC_FIREBASE_API_KEY=your_firebase_api_key_here
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_project_id_here

# å®Ÿéš›ã®å€¤ã¯.env.localï¼ˆ.gitignoreã«è¿½åŠ ï¼‰
NEXT_PUBLIC_FIREBASE_API_KEY=actual_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=techsnap-staging.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=techsnap-staging
```

### 11.2 å…¬é–‹ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### 11.2.1 ã‚³ãƒŸãƒƒãƒˆå‰ãƒã‚§ãƒƒã‚¯

- [ ] API ã‚­ãƒ¼ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹
- [ ] .env.local ãŒ.gitignore ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹
- [ ] ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹
- [ ] å€‹äººæƒ…å ±ã‚„ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹

#### 11.2.2 è‡ªå‹•ãƒã‚§ãƒƒã‚¯è¨­å®š

```yaml
# .github/workflows/security-check.yml
name: Security Check
on: [push, pull_request]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run truffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
```

### 11.3 ç·Šæ€¥æ™‚å¯¾å¿œï¼ˆæ©Ÿå¯†æƒ…å ±æ¼æ´©æ™‚ï¼‰

#### 11.3.1 å³åº§ã«å®Ÿè¡Œã™ã¹ãå¯¾å¿œ

```bash
# 1. è©²å½“ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ç„¡åŠ¹åŒ–
# Firebase: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§APIã‚­ãƒ¼ç„¡åŠ¹åŒ–
# Google Cloud: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼å‰Šé™¤

# 2. æ–°ã—ã„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç”Ÿæˆãƒ»è¨­å®š
# 3. GitHub Secretsã®æ›´æ–°
# 4. ç·Šæ€¥ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ

# 5. Gitå±¥æ­´ã‹ã‚‰ã®å‰Šé™¤ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
git filter-branch --force --index-filter \
  'git rm --cached --ignore-unmatch path/to/sensitive/file' \
  --prune-empty --tag-name-filter cat -- --all
```

#### 11.3.2 äº‹å¾Œå¯¾å¿œ

- [ ] å½±éŸ¿ç¯„å›²ã®èª¿æŸ»
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã®ç¢ºèª
- [ ] å†ç™ºé˜²æ­¢ç­–ã®å®Ÿè£…
- [ ] ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå ±å‘Šæ›¸ã®ä½œæˆ
